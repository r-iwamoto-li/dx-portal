<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>進行中プロジェクト一覧 | DX推進ポータル</title>
<meta name="description" content="DX推進ポータル | プロジェクト一覧" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f1a; --surface:#ffffff; --text:#121416; --muted:#6b7280;
  --brand:#2563eb; --brand-2:#8b5cf6; --shadow:0 10px 30px rgba(2,6,23,.14);
  --radius:16px; --chip:#eef2ff;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  color:var(--text); background:#f7f9fc; line-height:1.6; overflow-x:hidden;
}
a{color:inherit;text-decoration:none}
.container{max-width:1200px;margin:0 auto;padding:0 20px}

/* ===== Top Nav (TOPと同じ) ===== */
.topnav-wrap{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border-bottom:1px solid rgba(15,23,42,.06)}
.topnav{display:flex;gap:14px;align-items:center;justify-content:center;padding:10px 8px}
.pill{
  display:flex;gap:24px;align-items:center;justify-content:center;
  background:#f4f6fb;border:1px solid rgba(15,23,42,.06);
  border-radius:46px;padding:8px 14px;box-shadow:var(--shadow)
}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 14px;border-radius:28px;font-size:12px;color:#3b4252;font-weight:600;transition:transform .2s ease, background .2s ease, box-shadow .2s ease}
.nav-item:hover{background:#fff;transform:translateY(-2px)}
.nav-item.active{background:linear-gradient(135deg,rgba(37,99,235,.12),rgba(139,92,246,.12));color:var(--brand);box-shadow:0 6px 16px rgba(37,99,235,.18)}
.nav-ico{width:22px;height:22px;display:grid;place-items:center}

/* ===== Page Header (簡易) ===== */
.page-hero{padding:28px 0 6px}
.page-hero h1{font-family:"Noto Sans JP";font-size:28px;margin:10px 0 4px}
.page-hero p{color:#475569;margin:0}

/* ===== Filter Tabs ===== */
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0 22px}
.tab{
  border:1px solid rgba(15,23,42,.08); background:#fff;
  padding:8px 12px;border-radius:999px;font-weight:700;font-size:13px;color:#0f172a;
  cursor:pointer; transition:all .15s ease;
}
.tab:hover{transform:translateY(-1px)}
.tab.active{background:linear-gradient(135deg,rgba(37,99,235,.12),rgba(139,92,246,.12)); color:#1d4ed8; border-color:transparent}

/* ===== Cards Grid ===== */
.grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:18px}
@media (max-width: 1100px){ .grid{grid-template-columns:repeat(3,1fr)} }
@media (max-width: 800px){ .grid{grid-template-columns:repeat(2,1fr)} }
@media (max-width: 520px){ .grid{grid-template-columns:1fr} }

.card{
  background:#fff;border:1px solid rgba(15,23,42,.06);border-radius:18px;overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;transition:transform .15s ease, box-shadow .15s ease
}
.card:hover{transform:translateY(-2px); box-shadow:0 16px 36px rgba(2,6,23,.16)}
/* 画像は全カード同サイズ（16:10）で統一 */
.card-thumb{aspect-ratio: 16/10; background:#e5e7eb; display:grid; place-items:center; position:relative}
.card-thumb img{width:100%;height:100%;object-fit:cover}
.card-status{
  position:absolute;left:10px;top:10px;padding:6px 10px;border-radius:999px;
  background:#111827;color:#fff;font-weight:800;font-size:11px;letter-spacing:.02em
}

.card-body{padding:14px 14px 12px;display:flex;flex-direction:column;gap:10px}
.card-title{font-weight:800}
.card-tags{display:flex;gap:8px;flex-wrap:wrap}
.tag{font-size:11px;font-weight:800;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid rgba(15,23,42,.06)}
.card-meta{display:flex;align-items:center;gap:8px;color:#6b7280;font-size:12px}
.card-meta .small{opacity:.9}

/* ===== Footer ===== */
footer{padding:28px 0 36px;border-top:1px solid rgba(15,23,42,.06);margin-top:40px}
footer .container{color:#6b7280;text-align:center;font-size:14px}
</style>
</head>
<body>

  <!-- ===== Top Navigation ===== -->
  <div class="topnav-wrap">
    <nav class="topnav container">
      <div class="pill">
        <a class="nav-item" href="index.html#home">
          <span class="nav-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22"><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h14V10"/><path d="M9 20v-6h6v6"/></svg>
          </span><span>HOME</span>
        </a>
        <a class="nav-item active" href="projects.html">
          <span class="nav-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h5l2 3h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M3 7V5a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v3"/></svg>
          </span><span>プロジェクト</span>
        </a>
        <a class="nav-item" href="index.html#narrative">
          <span class="nav-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
              <path d="M3.5 6.5V18c4-.9 7-.9 10 .6"/><path d="M3.5 6.5C3.5 5.7 4.2 5 5 5h5c1.2 0 2.3.4 3 1"/>
              <path d="M20.5 6.5V18c-4-.9-7-.9-10 .6"/><path d="M20.5 6.5C20.5 5.7 19.8 5 19 5h-5c-1.2 0-2.3.4-3 1"/>
              <path d="M12 6v13"/><path d="M6.5 9.5c1.7-.5 3.3-.5 5 0"/><path d="M6.5 13c1.7-.5 3.3-.5 5 0"/><path d="M6.5 16.5c1.7-.5 3.3-.5 5 0"/><path d="M12.5 9.5c1.7-.5 3.3-.5 5 0"/><path d="M12.5 13c1.7-.5 3.3-.5 5 0"/><path d="M12.5 16.5c1.7-.5 3.3-.5 5 0"/>
            </svg>
          </span><span>ナレッジ</span>
        </a>
        <a class="nav-item" href="form.html">
          <span class="nav-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 1 1 12 0c0 7 3 7 3 9H3c0-2 3-2 3-9"/><path d="M10 21a2 2 0 0 0 4 0"/></svg>
          </span><span>問合せ</span>
        </a>
      </div>
    </nav>
  </div>

  <!-- ===== Page Header ===== -->
  <header class="page-hero container">
    <h1>プロジェクト一覧</h1>
    <p class="small">カテゴリタブで絞り込み／最終活動日は各ページの「活動履歴」から自動取得</p>
    <div id="tabs" class="tabs" role="tablist" aria-label="カテゴリ"></div>
  </header>

  <!-- ===== Cards ===== -->
  <main class="container">
    <section id="cards" class="grid" aria-live="polite"></section>
  </main>

  <footer>
    <div class="container">Copyright © <span id="year"></span>. All rights reserved.</div>
  </footer>

<script>
/* ====== 設定 ======
 cover は以下どれでもOK
  1) 直接画像URL（PNG/JPG/SVG 等）
  2) GitHub blob URL: https://github.com/{user}/{repo}/blob/{branch}/path/to/img.png
  3) 短縮: gh:{user}/{repo}/{branch}/path/to/img.png
*/
const PROJECTS = [
  {
    id:"project-overview",
    title:"概況（Management Overview）",
    href:"project-overview.html",
    cover:"gh:r-iwamoto-li/dx-portal/main/assets/projects/overview.png",
    status:"運用中",
    tags:["経営データ","ダッシュボード"],
    lastActivity:"" // 空なら自動取得
  },
  {
    id:"project-login-security",
    title:"事業推進会議",
    href:"project-login-security.html",
    cover:"https://github.com/r-iwamoto-li/dx-portal/blob/main/assets/projects/meeting.jpg",
    status:"運用中",
    tags:["経営データ","売上・利益"],
    lastActivity:""
  },
  {
    id:"project-payments",
    title:"空き工数管理",
    href:"project-payments.html",
    cover:"https://raw.githubusercontent.com/r-iwamoto-li/dx-portal/main/assets/projects/capacity.jpg",
    status:"進行中",
    tags:["人材管理","プロジェクト管理"],
    lastActivity:""
  },
  {
    id:"project-voucher",
    title:"クーポン管理（仮）",
    href:"project-voucher.html",
    cover:"gh:r-iwamoto-li/dx-portal/main/assets/projects/voucher.png",
    status:"計画中",
    tags:["マーケ"],
    lastActivity:""
  },
  {
    id:"project-points",
    title:"ポイント（仮）",
    href:"project-points.html",
    cover:"gh:r-iwamoto-li/dx-portal/main/assets/projects/points.jpg",
    status:"計画中",
    tags:["ロイヤリティ","マーケ"],
    lastActivity:""
  },
  {
    id:"project-orders",
    title:"注文（仮）",
    href:"project-orders.html",
    cover:"gh:r-iwamoto-li/dx-portal/main/assets/projects/orders.jpg",
    status:"運用中",
    tags:["EC","物流"],
    lastActivity:""
  }
];

/* ===== GitHub 画像URL -> raw 変換 ===== */
function toRawGitUrl(u){
  if(!u) return u;
  // gh:owner/repo/branch/path/to/file
  if(/^gh:/.test(u)){
    const rest = u.replace(/^gh:/,'');
    const [owner, repo, branch, ...path] = rest.split('/');
    return `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path.join('/')}`;
  }
  // https://github.com/.../blob/{branch}/path
  if(/^https?:\/\/github\.com\/.+\/blob\//.test(u)){
    return u.replace(/^https?:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/([^/]+)\/(.+)$/,'https://raw.githubusercontent.com/$1/$2/$3/$4');
  }
  return u; // すでに raw か外部画像
}

/* ===== タブ生成 ===== */
const tabsWrap = document.getElementById('tabs');
const cardsWrap = document.getElementById('cards');
const allTags = Array.from(new Set(PROJECTS.flatMap(p=>p.tags))).sort();
const TAB_ALL = "All";
const getHashTag = ()=> decodeURIComponent((location.hash.match(/tag=([^&]+)/)||[])[1]||"");

function renderTabs(activeTag){
  tabsWrap.innerHTML="";
  const tags=[TAB_ALL, ...allTags];
  tags.forEach(tag=>{
    const btn=document.createElement('button');
    btn.type="button";
    btn.className="tab"+((activeTag===tag)||(!activeTag && tag===TAB_ALL)?" active":"");
    btn.textContent= tag===TAB_ALL ? "すべて" : tag;
    btn.setAttribute('role','tab');
    btn.onclick=()=>{
      if(tag===TAB_ALL){ history.replaceState(null,"",location.pathname); }
      else{ location.hash = "tag="+encodeURIComponent(tag); }
      update();
    };
    tabsWrap.appendChild(btn);
  });
}

/* ===== 日付抽出ユーティリティ ===== */
function parseDateString(s){
  // 2025-09-14 or 2025/09/14 or 2025.09.14
  let m = s.match(/(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    return new Date(Date.UTC(y, mo-1, d));
  }
  // 2025年09月14日
  m = s.match(/(\d{4})\s*年\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    return new Date(Date.UTC(y, mo-1, d));
  }
  return null;
}

function formatISO(d){
  if(!d) return "";
  const y=d.getUTCFullYear();
  const m=String(d.getUTCMonth()+1).padStart(2,'0');
  const da=String(d.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

/* ===== プロジェクトページから最新日付を取得 ===== */
const activityCache = new Map(); // href -> YYYY-MM-DD

async function getLatestActivityDate(href){
  if(activityCache.has(href)) return activityCache.get(href);
  try{
    const res = await fetch(href, {cache:"no-store"});
    const html = await res.text();
    const doc = new DOMParser().parseFromString(html, "text/html");

    // 「活動履歴」セクションの近辺テキストを優先して抽出
    let scope = doc;
    const candidates = [...doc.querySelectorAll("*")].filter(el=>{
      const t = (el.textContent||"").trim();
      return /活動履歴|更新履歴|History|Changelog/i.test(t);
    });
    if(candidates.length){
      // セクション自身＋次の兄弟数個をまとめる
      const wrap = document.createElement('div');
      candidates.slice(0,2).forEach(el=>{
        wrap.appendChild(el.cloneNode(true));
        for(let i=0;i<3 && el.nextElementSibling;i++){
          wrap.appendChild(el.nextElementSibling.cloneNode(true));
        }
      });
      scope = wrap;
    }

    const text = scope.textContent || "";
    const dateStrings = text.match(/\d{4}[\/\-.]\d{1,2}[\/\-.]\d{1,2}|\d{4}\s*年\s*\d{1,2}\s*月\s*\d{1,2}\s*日/g) || [];

    // もし見つからなければ、ページ内の <time datetime> を拾う
    const timeDates = [...doc.querySelectorAll("time[datetime]")].map(t=>new Date(t.getAttribute("datetime")));
    timeDates.forEach(d=>dateStrings.push(formatISO(d)));

    let latest = null;
    for(const s of dateStrings){
      const d = parseDateString(s);
      if(d && (!latest || d>latest)) latest = d;
    }
    const iso = latest ? formatISO(latest) : "";
    activityCache.set(href, iso);
    return iso;
  }catch(e){
    console.warn("活動日取得エラー:", href, e);
    activityCache.set(href, "");
    return "";
  }
}

/* ===== カード描画 ===== */
async function renderCards(activeTag){
  const list = activeTag && activeTag!==TAB_ALL
    ? PROJECTS.filter(p=>p.tags.includes(activeTag))
    : PROJECTS;

  cardsWrap.innerHTML="";
  for(const p of list){
    const a = document.createElement('a');
    a.href = p.href; a.className="card"; a.setAttribute('aria-label', p.title);

    // thumb（GitHubパスをrawに補正）
    const th = document.createElement('div'); th.className="card-thumb";
    const img = document.createElement('img');
    img.loading = "lazy";
    img.decoding = "async";
    img.src = toRawGitUrl(p.cover);
    img.alt = "";
    const st = document.createElement('div'); st.className="card-status"; st.textContent = p.status;
    th.append(img, st);

    // body
    const body = document.createElement('div'); body.className="card-body";
    const title = document.createElement('div'); title.className="card-title"; title.textContent = p.title;

    const tags = document.createElement('div'); tags.className="card-tags";
    p.tags.forEach(t=>{ const s=document.createElement('span'); s.className="tag"; s.textContent=t; tags.appendChild(s) });

    const meta = document.createElement('div'); meta.className="card-meta";
    const span = document.createElement('span'); span.textContent = "最終活動日: ";
    const dateEl = document.createElement('strong'); dateEl.textContent = p.lastActivity || "読込中…";
    meta.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`;
    meta.append(span, dateEl);

    body.append(title, tags, meta);
    a.append(th, body);
    cardsWrap.appendChild(a);

    // 非同期で最終活動日を取得して更新
    if(!p.lastActivity){
      getLatestActivityDate(p.href).then(dt=>{
        if(dt) dateEl.textContent = dt;
        else   dateEl.textContent = "—";
      });
    }
  }
}

/* ===== 起動＆タブ制御 ===== */
function update(){
  const tag = getHashTag();
  renderTabs(tag||TAB_ALL);
  renderCards(tag);
}
window.addEventListener('hashchange', update);
document.getElementById('year').textContent = new Date().getFullYear();
update();
</script>
</body>
</html>
