<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DX推進ポータル</title>
<meta name="description" content="Link innovation | DX推進ポータル" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f1a; --surface:#ffffff; --text:#121416; --muted:#6b7280;
  --brand:#2563eb; --brand-2:#8b5cf6; --shadow:0 10px 30px rgba(2,6,23,.14);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  color:var(--text); background:#f7f9fc; line-height:1.6; overflow-x:hidden;
}
a{color:inherit;text-decoration:none}
.container{max-width:1200px;margin:0 auto;padding:0 20px}

/* ===== Top Nav ===== */
.topnav-wrap{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border-bottom:1px solid rgba(15,23,42,.06)}
.topnav{display:flex;gap:14px;align-items:center;justify-content:center;padding:10px 8px}
.pill{
  display:flex;gap:24px;align-items:center;justify-content:center;
  background:#f4f6fb;border:1px solid rgba(15,23,42,.06);
  border-radius:46px;padding:8px 14px;box-shadow:var(--shadow)
}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 14px;border-radius:28px;font-size:12px;color:#3b4252;font-weight:600;transition:transform .2s ease, background .2s ease, box-shadow .2s ease}
.nav-item:hover{background:#fff;transform:translateY(-2px)}
.nav-item.active{background:linear-gradient(135deg,rgba(37,99,235,.12),rgba(139,92,246,.12));color:var(--brand);box-shadow:0 6px 16px rgba(37,99,235,.18)}
.nav-ico{width:22px;height:22px;display:grid;place-items:center}

/* ===== Hero ===== */
.hero{position:relative;isolation:isolate}
.hero-media{position:relative;height:420px;overflow:hidden;background:#0f1226;border-bottom-left-radius:24px;border-bottom-right-radius:24px}
.hero-media img{
  position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.9;transform:scale(1.06); transition:transform 9s cubic-bezier(.2,.8,.2,1);
}
.hero-media::after{
  content:"";position:absolute;inset:0;pointer-events:none;
  background: radial-gradient(1200px 480px at 20% 20%, rgba(37,99,235,.35), transparent 50%),
              radial-gradient(900px 420px at 80% 30%, rgba(139,92,246,.35), transparent 55%),
              linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.85) 82%);
}
.hero-media canvas#fx{position:absolute;inset:0;mix-blend-mode:screen;opacity:.9;z-index:1}
.hero-inner{position:relative;z-index:2}
.hero-grid{display:grid;grid-template-columns:1.25fr .9fr;gap:48px;align-items:center;margin-top:-320px;padding:0 0 48px}
.eyebrow{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.72);border:1px solid rgba(15,23,42,.06);backdrop-filter: blur(6px);font-size:12px;font-weight:700;letter-spacing:.06em}
.hero h1{font-family:"Noto Sans JP";font-size:48px;line-height:1.2;margin:16px 0 10px;letter-spacing:.02em}
.hero h1 .glow{display:inline-block;filter:drop-shadow(0 4px 14px rgba(37,99,235,.55))}
.hero p.sub{color:#2f3947;font-weight:500}
.cta{margin-top:24px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;border-radius:999px;background:#111827;color:#fff;font-weight:700;box-shadow:var(--shadow);transform:translateZ(0);transition:transform .15s ease}
.btn:hover{transform:translateY(-1px)}

/* ===== Main ===== */
main{padding:56px 0}
.grid-2{display:grid;grid-template-columns:1.1fr 1fr;gap:32px}
h2{font-family:"Noto Sans JP";font-size:26px;margin:0 0 18px}
.card{position:relative;background:#fff;border:1px solid rgba(15,23,42,.06);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card::before{
  content:"";position:absolute;inset:-1px;border-radius:calc(var(--radius) + 1px);padding:1px;background:
  linear-gradient(90deg, rgba(37,99,235,.35), rgba(139,92,246,.35), rgba(37,99,235,.35));
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude;
  animation:borderShift 8s linear infinite; pointer-events:none;
}
@keyframes borderShift{0%{background-position:0 0}100%{background-position:200% 0}}
.list{padding:8px 0;margin:0}
.list li{list-style:none;display:flex;align-items:center;gap:12px;padding:14px 16px}
.list li + li{border-top:1px dashed rgba(15,23,42,.08)}
.dot{width:8px;height:8px;border-radius:999px;background:linear-gradient(135deg,var(--brand),var(--brand-2))}
.title{font-weight:700}
.badge{margin-left:auto;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(15,23,42,.08);background:#111827;color:#fff}
.toolbar{display:flex;align-items:center;gap:10px;justify-content:flex-end}
.select{position:relative}
.select select{appearance:none;border:1px solid rgba(15,23,42,.12);padding:8px 32px 8px 12px;border-radius:10px;background:#fff;font-weight:600}
.select svg{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;pointer-events:none}
.comment{display:grid;grid-template-columns:48px 1fr;gap:14px;padding:16px}
.comment + .comment{border-top:1px dashed rgba(15,23,42,.08)}
.avatar{width:48px;height:48px;border-radius:999px;background:#e5e7eb;display:grid;place-items:center;font-weight:800;color:#374151}
.c-name{font-weight:700}
.c-meta{color:#6b7280;font-size:12px}
.actions{display:flex;gap:12px;font-size:13px}
.stars{margin-left:auto;display:flex;gap:4px}
.star{width:16px;height:16px}

/* ===== Reveal ===== */
.reveal{opacity:0;transform:translateY(16px) scale(.98);filter:blur(6px);transition:opacity .7s ease, transform .7s ease, filter .7s ease}
.reveal.on{opacity:1;transform:none;filter:none}

/* ===== Intro (3D Geometry Morph) ===== */
.intro{
  position:fixed; inset:0; z-index:999; overflow:hidden;
  background:linear-gradient(135deg,#05070f,#0b1020 60%,#0b1020);
  display:block; opacity:1; transition:opacity .6s ease;
}
.intro.fade-out{opacity:0}
#geoFx{position:absolute; inset:0; width:100%; height:100%; opacity:.9; filter:drop-shadow(0 0 22px rgba(56,189,248,.22))}
.intro .logo{
  position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  color:#dbeafe; font-weight:900; font-size:20px; letter-spacing:.08em;
  text-shadow:0 0 20px rgba(37,99,235,.45); user-select:none; z-index:2;
}
/* フラッシュ（未来へジャンプ感） */
.intro.fade-out::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.95) 0%, rgba(255,255,255,.75) 10%, rgba(37,99,235,.45) 25%, transparent 60%);
  animation:warpOut .65s ease forwards;
  mix-blend-mode:screen;
}
@keyframes warpOut{0%{transform:scale(.18);opacity:1}100%{transform:scale(6);opacity:0}}

/* ===== Typing & Glitch（共通） ===== */
.typer{position:relative;display:inline-block}
.typer::after{content:"";position:absolute;right:-2px;bottom:0;width:10px;height:1.15em;background:linear-gradient(#111827,#111827) no-repeat center/2px 1em;animation:blink .9s steps(1,end) infinite}
@keyframes blink{50%{opacity:0}}
.glitch-burst{position:relative;filter:contrast(1.08)}
.glitch-burst::before,.glitch-burst::after{content:attr(data-glitch);position:absolute;left:0;top:0;pointer-events:none;mix-blend-mode:screen;opacity:.0}
.glitch-burst::before{color:#ff2a6d}
.glitch-burst::after {color:#29adff}
.glitch-burst.on::before{opacity:.9;transform:translate(-1px,0)}
.glitch-burst.on::after {opacity:.9;transform:translate(1px,0)}
.scanlines{position:fixed;inset:0;pointer-events:none;z-index:35;mix-blend-mode:multiply;opacity:0;background:repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0px, rgba(0,0,0,.06) 1px, transparent 2px, transparent 4px);animation:lines .18s steps(2,end) infinite}
@keyframes lines{to{background-position-y:4px}}
.scanlines.on{opacity:.45; animation-duration:.12s}

/* ===== 3行メッセージ（下線の走査） ===== */
.mv-copy{background:transparent;border:none;backdrop-filter:none;padding:8px 0;box-shadow:none}
.mvv-lines{display:grid;gap:10px}
.mvv-line{position:relative;display:block;font-weight:700;color:#0f172a}
.mvv-line.alive::after{
  content:""; position:absolute; left:0; right:0; bottom:-4px; height:2px;
  background:linear-gradient(90deg, transparent, rgba(37,99,235,.55), transparent);
  animation:scan 1.8s ease-in-out infinite; border-radius:2px;
}
@keyframes scan{0%{transform:translateX(-40%)}50%{transform:translateX(40%)}100%{transform:translateX(-40%)}}

/* ===== 文字ラップ（h1は白背景なし） ===== */
.charify:not(.no-bg) .ink-bg{
  display:inline-block; background:#fff; color:#0f172a;
  padding:4px 6px; border-radius:8px; box-shadow:0 1px 0 rgba(0,0,0,.05);
  box-decoration-break:clone; -webkit-box-decoration-break:clone;
}
.char{display:inline-block}

/* ===== 文字ノイズ（ランダム方向＆間隔） ===== */
.char.glitch{
  transform: translate(var(--gx,0px), var(--gy,0px)) rotate(var(--grot,0deg));
  text-shadow: calc(var(--sx,-2px)) 0 rgba(255,42,109,.65),
               calc(var(--cx,  2px)) 0 rgba(41,173,255,.65);
  animation: flashHue 140ms linear;
  will-change: transform, text-shadow, filter;
}
@keyframes flashHue{
  0%{filter:contrast(1.05) saturate(1.05)}
  50%{filter:contrast(1.25) saturate(1.25)}
  100%{filter:contrast(1.05) saturate(1.05)}
}

/* ===== Footer ===== */
footer{padding:28px 0 36px;border-top:1px solid rgba(15,23,42,.06)}
footer .container{color:#6b7280;text-align:center;font-size:14px}

/* ===== Responsive ===== */
@media (max-width:980px){
  .hero-media{height:380px}
  .hero-grid{grid-template-columns:1fr;gap:24px;margin-top:-300px}
  .mv-copy{order:-1}
  .grid-2{grid-template-columns:1fr}
}
@media (max-width:560px){
  .nav-item{gap:2px;padding:8px 10px}
  .nav-ico{width:20px;height:20px}
  .hero h1{font-size:36px}
}
/* Clickable row */
.list li{padding:0}
.project-link{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;outline:none;transition:background .18s ease, transform .06s ease}
.project-link:hover{background:rgba(37,99,235,.06);transform:translateY(-1px)}
.project-link:active{transform:translateY(0)}
.project-link:focus-visible{box-shadow:0 0 0 3px rgba(37,99,235,.35);background:#fff}
</style>
</head>
<body>
  <!-- Intro -->
  <div class="intro" id="intro">
    <canvas id="geoFx"></canvas>
    <div class="logo">DX PORTAL • INITIALIZING…</div>
  </div>
  <div class="scanlines" id="scanlines"></div>

  <!-- ===== Top Navigation ===== -->
  <div class="topnav-wrap">
    <nav class="topnav container">
      <div class="pill" id="magnet">
        <a class="nav-item active" href="#home" aria-current="page">
          <span class="nav-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22"><path d="M3 10.5 12 3l9 7.5"/><path d="M5 10v10h14V10"/><path d="M9 20v-6h6v6"/></svg>
          </span>
          <span>HOME</span>
        </a>
        <a class="nav-item" href="#projects">
          <span class="nav-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h5l2 3h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M3 7V5a2 2 0 0 1 2-2h4l2 2h6a2 2 0 0 1 2 2v3"/></svg>
          </span>
          <span>プロジェクト</span>
        </a>
        <a class="nav-item" href="#narrative">
          <span class="nav-ico" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="22" height="22">
              <path d="M3.5 6.5V18c4-.9 7-.9 10 .6"/><path d="M3.5 6.5C3.5 5.7 4.2 5 5 5h5c1.2 0 2.3.4 3 1"/>
              <path d="M20.5 6.5V18c-4-.9-7-.9-10 .6"/><path d="M20.5 6.5C20.5 5.7 19.8 5 19 5h-5c-1.2 0-2.3.4-3 1"/>
              <path d="M12 6v13"/><path d="M6.5 9.5c1.7-.5 3.3-.5 5 0"/><path d="M6.5 13c1.7-.5 3.3-.5 5 0"/><path d="M6.5 16.5c1.7-.5 3.3-.5 5 0"/><path d="M12.5 9.5c1.7-.5 3.3-.5 5 0"/><path d="M12.5 13c1.7-.5 3.3-.5 5 0"/><path d="M12.5 16.5c1.7-.5 3.3-.5 5 0"/>
            </svg>
          </span>
          <span>ナレッジ</span>
        </a>
        <a class="nav-item" href="#contact">
          <span class="nav-ico" aria-hidden>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 1 1 12 0c0 7 3 7 3 9H3c0-2 3-2 3-9"/><path d="M10 21a2 2 0 0 0 4 0"/></svg>
          </span>
          <span>問合せ</span>
        </a>
      </div>
    </nav>
  </div>

  <!-- ===== Hero ===== -->
  <section id="home" class="hero">
    <div class="hero-media">
      <img id="heroImg" src="https://raw.githubusercontent.com/r-iwamoto-li/dx-portal/9ec9a663d1166b703e5e36f653841ad459a546d3/360_F_743682104_ti07mGClxONYK6SVRGLr7WT7A8Tz070X.jpg" alt="DX Portal hero background" />
      <canvas id="fx"></canvas>
    </div>
    <div class="hero-inner container">
      <div class="hero-grid">
        <div class="reveal">
          <span class="eyebrow typer" data-text="DX Innovation"></span>
          <!-- h1 は白背景なし -->
          <h1 id="headline" class="glitch-burst typer charify no-bg" data-glitch="" data-text="常識を疑え\n“標準”を再定義"></h1>
          <p class="sub typer" data-text="Question the norm, reconstruct the standard"></p>
          <div class="cta"><a class="btn" href="#contact">お問い合せ</a></div>
        </div>

        <!-- 3行コピー（白背景の“連結”付き） -->
        <div class="mv-copy reveal">
          <div class="mvv-lines">
            <div class="mvv-line typer charify" data-text="デジタルの力で業務を再構築し、組織の可能性を余さず引き出す。"></div>
            <div class="mvv-line typer charify" data-text="すべての業務と人を“デジタルネイティブ化”し、進化し続ける企業を目指す。"></div>
            <div class="mvv-line typer charify" data-text="挑戦を称え、共創を楽しみ、成果にこだわる。"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== Main ===== -->
  <main class="container">
    <div class="grid-2">
      <!-- Projects -->
      <section id="projects" class="reveal">
        <h2>進行中プロジェクト</h2>
        <div class="card">
          <ul class="list">
            <li><a class="project-link" href="project-overview.html"><span class="dot"></span><span class="title">概況</span><span class="badge">進行中</span></a></li>
            <li><a class="project-link" href="project-login-security.html"><span class="dot"></span><span class="title">Login and security</span><span class="badge">進行中</span></a></li>
            <li><a class="project-link" href="project-payments.html"><span class="dot"></span><span class="title">My payments</span></a></li>
            <li><a class="project-link" href="project-voucher.html"><span class="dot"></span><span class="title">My voucher</span></a></li>
            <li><a class="project-link" href="project-points.html"><span class="dot"></span><span class="title">My points</span></a></li>
            <li><a class="project-link" href="project-orders.html"><span class="dot"></span><span class="title">My orders</span></a></li>
          </ul>
        </div>
      </section>

      <!-- News -->
      <section aria-labelledby="news-title" class="reveal">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <h2 id="news-title">お知らせ</h2>
          <div class="toolbar">
            <div class="select">
              <select aria-label="ソート">
                <option>Newest</option><option>Oldest</option><option>Most liked</option>
              </select>
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
            </div>
          </div>
        </div>
        <div class="card" role="list">
          <article class="comment" role="listitem">
            <div class="avatar" aria-hidden="true">OB</div>
            <div>
              <div style="display:flex;align-items:center;gap:12px">
                <span class="c-name">Osbaldo Beahan</span>
                <span class="c-meta">about 1 hour ago</span>
                <div class="stars" aria-label="rating: 5 of 5">
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                </div>
              </div>
              <p style="margin:.4rem 0 0.6rem">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Id neque mattis molestie eget phasellus tellus amet duis in.</p>
              <div class="actions"><a href="#">Like</a> <a href="#">Reply</a></div>
            </div>
          </article>

          <article class="comment" role="listitem">
            <div class="avatar" aria-hidden="true">OB</div>
            <div>
              <div style="display:flex;align-items:center;gap:12px">
                <span class="c-name">Osbaldo Beahan</span>
                <span class="c-meta">about 1 hour ago</span>
                <div class="stars" aria-label="rating: 4 of 5">
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor" opacity=".35"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                  <svg class="star" viewBox="0 0 24 24" fill="currentColor" opacity=".35"><path d="M12 17.3 5.8 21l1.6-7-5.4-4.7 7.1-.6L12 2l2.9 6.7 7.1.6-5.4 4.7 1.6 7z"/></svg>
                </div>
              </div>
              <p style="margin:.4rem 0 0.6rem">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Id neque mattis molestie eget phasellus tellus amet duis in.</p>
              <div class="actions"><a href="#">Like</a> <a href="#">Reply</a></div>
            </div>
          </article>
        </div>
      </section>
    </div>
  </main>

  <footer class="reveal">
    <div class="container">Copyright © <span id="year"></span>. All rights reserved.</div>
  </footer>

<script>
/* ===== Intro 3D Geometry Morph ===== */
(function(){
  const intro = document.getElementById('intro');
  const canvas = document.getElementById('geoFx');
  const ctx = canvas.getContext('2d');
  let W=0,H=0,dpr=1;

  function resize(){
    dpr = Math.min(2, window.devicePixelRatio||1);
    W = canvas.clientWidth; H = canvas.clientHeight;
    canvas.width = W*dpr; canvas.height = H*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize); resize();

  // フィボナッチ球分布（点の“ID”は固定 → どの形にもマップ可能）
  const COUNT = 420; // 点数（多いほど複雑）
  const base = [];
  for(let i=0;i<COUNT;i++){
    const y = 1 - (i/(COUNT-1))*2;                 // -1..1
    const r = Math.sqrt(1 - y*y);
    const phi = (Math.PI * (3 - Math.sqrt(5))) * i; // 黄金角
    base.push([Math.cos(phi)*r, y, Math.sin(phi)*r]); // 単位球
  }

  // 形状ターゲット（同じ個数の点へ写像）
  const R = Math.min(W,H)*0.28;

  function mapSphere(p){ return mul(p, R); }

  function mapSuperquadric(p, e1=2.0, e2=2.0, s=R){ // e1,e2 < 2で角ばる
    const [x,y,z]=p;
    const nx = Math.sign(x)*Math.pow(Math.abs(x), 2/e1);
    const ny = Math.sign(y)*Math.pow(Math.abs(y), 2/e2);
    const nz = Math.sign(z)*Math.pow(Math.abs(z), 2/e1);
    return [nx*s, ny*s, nz*s];
  }
  function mapOcta(p){ // 菱形体（L1ノルム）
    let [x,y,z]=p.map(Math.abs);
    const k = 1/(x+y+z+1e-6);
    return mul([Math.sign(p[0])*x*k, Math.sign(p[1])*y*k, Math.sign(p[2])*z*k], R);
  }
  function mapCube(p){ // 球→立方体表面
    const [x,y,z]=p;
    const ax=Math.abs(x), ay=Math.abs(y), az=Math.abs(z);
    const m = Math.max(ax,ay,az);
    return mul([x/m, y/m, z/m], R);
  }
  function mapTorus(p){ // トーラス風（擬似）
    const R0 = R*0.75, r = R*0.28;
    // 球点 → 角度に読み替え
    const u = Math.atan2(p[2], p[0]);   // 周方向
    const v = Math.asin(p[1]);          // 断面
    const x = (R0 + r*Math.cos(2*v)) * Math.cos(u*1.2);
    const y = r*Math.sin(2*v);
    const z = (R0 + r*Math.cos(2*v)) * Math.sin(u*1.2);
    return [x,y,z];
  }

  const targets = [
    (p)=>mapSphere(p),                 // 球
    (p)=>mapSuperquadric(p, 1.0, 1.0), // 丸みのある立方体前段
    (p)=>mapCube(p),                   // 立方体
    (p)=>mapSuperquadric(p, 0.6, 0.6), // さらに角強調
    (p)=>mapOcta(p),                   // 菱形体（八面体系）
    (p)=>mapSuperquadric(p, 1.6, 1.6), // 緩やかに戻す
    (p)=>mapTorus(p),                  // トーラス風
    (p)=>mapSphere(p)                  // 球に回帰
  ];

  let a = base.map(mapSphere);
  let b = base.map(mapCube);
  let idx = 1;
  let t = 0; // 0..1
  const morphMs = 1200; // モーフ時間
  const holdMs  = 300;

  // 透視投影
  function proj([x,y,z]){
    const zshift = z + R*3.2;
    const s = (R*1.8) / zshift;
    return [W/2 + x*s, H/2 + y*s];
  }
  const mul=(v,k)=>[v[0]*k,v[1]*k,v[2]*k];

  // 近傍結線用にインデックスを作っておく（等間隔で近い点）
  const neighbors = [];
  const K = 6;
  for(let i=0;i<COUNT;i++){
    const n=[];
    for(let j=1;j<=K;j++) n.push((i+j*3)%COUNT);
    neighbors.push(n);
  }

  let last = performance.now(), holdLeft = holdMs;
  function easeInOut(k){return 0.5 - 0.5*Math.cos(Math.PI*k)}

  function render(now){
    const dt = now - last; last = now;

    if(holdLeft>0){ holdLeft -= dt; }
    else{
      t += dt/morphMs;
      if(t>=1){
        t = 0;
        a = b;
        idx = (idx+1)%targets.length;
        b = base.map(targets[idx]);
        holdLeft = holdMs;
      }
    }

    // 背景グラデをうっすら流す
    ctx.clearRect(0,0,W,H);
    const grd = ctx.createLinearGradient(0,0,W,H);
    grd.addColorStop(0,'rgba(15,23,42,.35)');
    grd.addColorStop(1,'rgba(2,6,23,.15)');
    ctx.fillStyle = grd; ctx.fillRect(0,0,W,H);

    // 回転（全体にゆっくり）
    const rot = now*0.0006;
    const cos= Math.cos(rot), sin=Math.sin(rot);
    function rotY([x,y,z]){ const nx=cos*x+sin*z; const nz=-sin*x+cos*z; return [nx,y,nz]; }
    function rotX([x,y,z]){ const cy=Math.cos(rot*0.6), sy=Math.sin(rot*0.6); const ny=cy*y - sy*z; const nz=sy*y + cy*z; return [x,ny,nz]; }

    const k = easeInOut(t);
    const pts3 = new Array(COUNT);
    for(let i=0;i<COUNT;i++){
      const p = a[i], q = b[i];
      // 補間→回転
      const cur = [p[0]+(q[0]-p[0])*k, p[1]+(q[1]-p[1])*k, p[2]+(q[2]-p[2])*k];
      pts3[i] = rotX(rotY(cur));
    }

    // 描画（奥→手前でα強め）
    const order = pts3.map((p,i)=>[i,p[2]]).sort((m,n)=>m[1]-n[1]).map(x=>x[0]);

    // 結線
    ctx.lineWidth = 1;
    for(const i of order){
      const p = proj(pts3[i]);
      for(const j of neighbors[i]){
        const q = proj(pts3[j]);
        const dx=p[0]-q[0], dy=p[1]-q[1], d = Math.hypot(dx,dy);
        if(d<180){
          const op = 0.08 + 0.18*Math.max(0,1 - d/180);
          const g = ctx.createLinearGradient(p[0],p[1],q[0],q[1]);
          g.addColorStop(0,`rgba(37,99,235,${op})`);
          g.addColorStop(1,`rgba(139,92,246,${op})`);
          ctx.strokeStyle=g;
          ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.lineTo(q[0],q[1]); ctx.stroke();
        }
      }
    }

    // ノード
    for(const i of order){
      const [x,y] = proj(pts3[i]);
      ctx.fillStyle='rgba(148,163,184,.85)';
      ctx.beginPath(); ctx.arc(x,y,1.4,0,Math.PI*2); ctx.fill();
    }

    // 4.6秒後にイントロ終了（フラッシュ→remove）
    if(now < 4600) requestAnimationFrame(render);
    else{
      intro.classList.add('fade-out');
      setTimeout(()=> intro.remove(), 700);
    }
  }
  requestAnimationFrame(render);
})();

/* ===== Hero パーティクル（既存） ===== */
(function(){
  const c = document.getElementById('fx'), ctx = c.getContext('2d',{alpha:true});
  let W=0,H=0, dpr = Math.min(2, window.devicePixelRatio||1);
  const P=[], MAX=90;
  function resize(){ W = c.clientWidth = c.parentElement.clientWidth; H = c.clientHeight = c.parentElement.clientHeight; c.width = W*dpr; c.height = H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0) }
  function add(n=MAX){ P.length=0; for(let i=0;i<n;i++){ P.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.6,vy:(Math.random()-.5)*.6,r:1.4+Math.random()*1.3}); } }
  function loop(){
    ctx.clearRect(0,0,W,H);
    ctx.strokeStyle='rgba(37,99,235,.08)'; ctx.lineWidth=1;
    for(let y=0;y<H;y+=48){ctx.beginPath();ctx.moveTo(0,y+.5);ctx.lineTo(W,y+.5);ctx.stroke()}
    for(let x=0;x<W;x+=64){ctx.beginPath();ctx.moveTo(x+.5,0);ctx.lineTo(x+.5,H);ctx.stroke()}
    for(let i=0;i<P.length;i++){
      const a=P[i]; a.x+=a.vx; a.y+=a.vy;
      if(a.x<0||a.x>W) a.vx*=-1; if(a.y<0||a.y>H) a.vy*=-1;
      ctx.fillStyle='rgba(139,92,246,.85)'; ctx.beginPath(); ctx.arc(a.x,a.y,a.r,0,Math.PI*2); ctx.fill();
      for(let j=i+1;j<P.length;j++){
        const b=P[j], dx=a.x-b.x, dy=a.y-b.y, dist=dx*dx+dy*dy;
        if(dist<9000){
          const op = 1 - dist/9000;
          const g = ctx.createLinearGradient(a.x,a.y,b.x,b.y);
          g.addColorStop(0,'rgba(37,99,235,'+ (0.35*op) +')');
          g.addColorStop(1,'rgba(139,92,246,'+ (0.35*op) +')');
          ctx.strokeStyle=g; ctx.lineWidth=1.2*op; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        }
      }
    }
    requestAnimationFrame(loop);
  }
  window.addEventListener('resize', ()=>{resize(); add()});
  resize(); add(); loop();
})();

/* ===== Reveal on scroll ===== */
const io = new IntersectionObserver((ents)=>{ ents.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('on'); io.unobserve(e.target)} }) },{threshold:.18});
document.querySelectorAll('.reveal').forEach(el=>io.observe(el));

/* ===== Parallax zoom ===== */
const heroImg = document.getElementById('heroImg');
window.addEventListener('scroll', ()=>{ const y = Math.min(1, window.scrollY/600); heroImg.style.transform = `scale(${1.06 + y*0.06}) translateY(${y*10}px)`; });

/* ===== Magnet nav ===== */
(function(){
  const wrap=document.getElementById('magnet');
  const items=[...wrap.querySelectorAll('.nav-item')];
  wrap.addEventListener('mousemove', e=>{
    const rect = wrap.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    items.forEach(it=>{
      const r = it.getBoundingClientRect();
      const cx = r.left - rect.left + r.width/2;
      const cy = r.top  - rect.top  + r.height/2;
      const dx = (mx-cx)/r.width, dy=(my-cy)/r.height;
      it.style.transform = `translate(${dx*6}px,${dy*6}px)`;
    });
  });
  wrap.addEventListener('mouseleave', ()=>items.forEach(it=>it.style.transform=''));
})();

/* ===== 年自動挿入 ===== */
document.getElementById('year').textContent = new Date().getFullYear();

/* ===== Typing + 文字分割 + ランダムノイズ ===== */
(async function(){
  const scan = document.getElementById('scanlines');

  const toHTMLBr = s => s.replace(/\n/g,'<br>'); // 改行を <br> に
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const rand  = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
  function scramble(s, rate=0.25){
    const pool = 'アイウエオカキクケコサシスセソﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789*#=+<>';
    return s.split('').map(ch => Math.random()<rate ? pool[rand(0,pool.length-1)] : ch).join('');
  }

  // h1用：白背景なしのプレーン文字分割
  function wrapCharsPlain(html){
    const PLACE='[[BR]]';
    const withMarks = html.replace(/<br\s*\/?>/gi, PLACE);
    const chars=[...withMarks];
    let out = '';
    for(let i=0;i<chars.length;i++){
      if(withMarks.slice(i, i + PLACE.length) === PLACE){out += '<br>';i += PLACE.length - 1;continue;}
      const ch = chars[i]===' ' ? '&nbsp;' : chars[i];
      out += `<span class="char">${ch}</span>`;
    }
    return out;
  }
  // 白背景あり：文章を連結白背景の中に1文字ずつ
  function wrapForInk(html){
    const PLACE='[[BR]]';
    const withMarks = html.replace(/<br\s*\/?>/gi, PLACE);
    const chars=[...withMarks];
    let out = '<span class="ink"><span class="ink-bg">';
    for(let i=0;i<chars.length;i++){
      if(withMarks.slice(i, i + PLACE.length) === PLACE){out += '</span></span><br><span class="ink"><span class="ink-bg">';i += PLACE.length - 1;continue;}
      const ch = chars[i]===' ' ? '&nbsp;' : chars[i];
      out += `<span class="char">${ch}</span>`;
    }
    out += '</span></span>';
    return out;
  }

  async function typeNode(el, text, speed=[16,38], noiseEvery=rand(12,20)){
    const norm = text.replace(/\\n/g, '\n'); // \n → 実改行
    el.classList.add('typer');
    el.setAttribute('data-glitch', norm.replace(/\n/g,' '));

    let out='', tick=0;
    for(let i=0;i<norm.length;i++){
      out += norm[i];
      const html = toHTMLBr(out);
      if(el.classList.contains('charify')){
        el.innerHTML = el.classList.contains('no-bg') ? wrapCharsPlain(html) : wrapForInk(html);
      }else{
        el.innerHTML = html;
      }
      tick++;

      // タイプ中の小ノイズ
      if(tick % noiseEvery === 0 && i < norm.length-1){
        const keep = out.slice(0,-Math.min(6,out.length));
        const mess = scramble(out.slice(-Math.min(6,out.length)), .7);
        const html2 = toHTMLBr(keep + mess);
        el.innerHTML = el.classList.contains('charify')
          ? (el.classList.contains('no-bg') ? wrapCharsPlain(html2) : wrapForInk(html2))
          : html2;
        el.classList.add('glitch-burst','on'); scan.classList.add('on');
        await sleep(70);
        el.classList.remove('on'); scan.classList.remove('on');
      }
      await sleep(rand(speed[0],speed[1]));
    }
    el.classList.remove('typer');
    el.classList.add('alive');

    // 文字単位ノイズ（ランダム間隔＆ランダム方向）
    if(el.classList.contains('charify')) startPerCharNoise(el);
  }

  function startPerCharNoise(container){
    const getChars = ()=>[...container.querySelectorAll('.char')];
    (function loop(){
      const nextIn = rand(1100, 2600);
      setTimeout(()=>{
        const chars = getChars();
        if(chars.length){
          const burst = rand(1,3);
          for(let i=0;i<burst;i++){
            const t = chars[rand(0, chars.length-1)];
            const gx = rand(-3,3), gy = rand(-3,3), rot = rand(-6,6)/10;
            const sx = rand(-3,-1), cx = rand(1,3);
            t.style.setProperty('--gx', gx+'px');
            t.style.setProperty('--gy', gy+'px');
            t.style.setProperty('--grot', rot+'deg');
            t.style.setProperty('--sx', sx+'px');
            t.style.setProperty('--cx', cx+'px');
            t.classList.add('glitch');
            setTimeout(()=>{
              t.classList.remove('glitch');
              t.style.removeProperty('--gx'); t.style.removeProperty('--gy'); t.style.removeProperty('--grot');
              t.style.removeProperty('--sx'); t.style.removeProperty('--cx');
            }, rand(110, 200));
          }
        }
        loop();
      }, nextIn);
    })();
  }

  // ===== シーケンス =====
  const eyebrow = document.querySelector('.eyebrow');
  const h1 = document.getElementById('headline');
  const sub = document.querySelector('.sub');
  const mvvLines = [...document.querySelectorAll('.mvv-line')];

  const INTRO_MS = 4600;
  await sleep(INTRO_MS + 120);
  await typeNode(eyebrow, eyebrow.dataset.text, [10,24]);
  await typeNode(h1, h1.dataset.text, [24,42]);     // h1：白背景なしで改行OK
  await typeNode(sub, sub.dataset.text, [12,24]);

  for(const line of mvvLines){
    await typeNode(line, line.dataset.text, [12,28]);
    await sleep(80);
  }
})();
</script>
</body>
</html>
